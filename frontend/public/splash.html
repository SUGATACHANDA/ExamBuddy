<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <title>Exam Buddy ‚Äì System Check</title>
    <style>
        * {
            /* Firefox */
            scrollbar-width: none;

            /* IE and Edge */
            -ms-overflow-style: none;
            user-select: none;
        }

        *::-webkit-scrollbar {
            display: none;
            /* Chrome, Safari, Opera */
        }

        body {
            background: #2563EB;
            color: white;
            font-family: system-ui;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        .container {
            width: 320px;
            text-align: center;
        }

        h1 {
            margin-bottom: 20px;
        }

        .check {
            display: flex;
            align-items: center;
            margin: 12px 0;
            height: 24px;
            opacity: 1;
            /* Start with full opacity */
            transition: opacity 0.3s ease;

        }

        #service {
            opacity: 0;
            visibility: hidden;
            height: 24px;
            /* Same fixed height */
        }

        #service.visible {
            opacity: 1;
            visibility: visible;
        }

        .loader {
            width: 18px;
            height: 18px;
            border: 3px solid rgba(255, 255, 255, 0.4);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 12px;
        }

        .tick {
            color: #22C55E;
            font-size: 18px;
            margin-right: 12px;
        }

        .cross {
            color: #EF4444;
            font-size: 18px;
            margin-right: 12px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #status-text {
            margin-bottom: 20px;
            min-height: 24px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Exam Buddy</h1>
        <p id="status-text">Initializing Secure Environment</p>

        <div class="check" id="camera">
            <div class="loader"></div>Camera
        </div>
        <div class="check" id="microphone">
            <div class="loader"></div>Microphone
        </div>
        <div class="check" id="internet">
            <div class="loader"></div>Internet
        </div>
        <div class="check" id="display">
            <div class="loader"></div>Single Display
        </div>
        <div class="check" id="service">
            <div class="loader"></div>Service Status
        </div>
    </div>

    <script>
        const { ipcRenderer } = require("electron");

        const sleep = (ms) => new Promise(res => setTimeout(res, ms));

        const setLoader = (id) => {
            const element = document.getElementById(id);
            if (element) {
                element.innerHTML = `<div class="loader"></div>${idLabel(id)}`;
                element.style.display = 'flex';
                if (id === 'service') {
                    element.classList.add('visible');
                }
            }
        };

        const setTick = (id) => {
            const element = document.getElementById(id);
            if (element) {
                element.innerHTML = `<span class="tick">‚úî</span>${idLabel(id)}`;
                element.style.display = 'flex';
                if (id === 'service') {
                    element.classList.add('visible');
                }
            }
        };

        const setCross = (id) => {
            const element = document.getElementById(id);
            if (element) {
                element.innerHTML = `<span class="cross">‚úó</span>${idLabel(id)}`;
                element.style.display = 'flex';
                if (id === 'service') {
                    element.classList.add('visible');
                }
            }
        };

        const idLabel = (id) => ({
            camera: "Camera",
            microphone: "Microphone",
            internet: "Internet",
            display: "Single Display",
            service: "Service Status"
        }[id] || id);

        async function checkMedia() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                return {
                    camera: devices.some(d => d.kind === "videoinput"),
                    microphone: devices.some(d => d.kind === "audioinput")
                };
            } catch (error) {
                console.error("Media check failed:", error);
                return { camera: false, microphone: false };
            }
        }

        async function runAllChecks() {
            try {
                // Step 1: Run system checks
                document.getElementById("status-text").textContent = "Running system checks...";

                // 1Ô∏è‚É£ Camera
                setLoader("camera");
                await sleep(600);
                const media = await checkMedia();
                if (!media.camera) {
                    setCross("camera");
                    throw ["camera"];
                }
                setTick("camera");

                // 2Ô∏è‚É£ Microphone
                setLoader("microphone");
                await sleep(600);
                if (!media.microphone) {
                    setCross("microphone");
                    throw ["microphone"];
                }
                setTick("microphone");

                // 3Ô∏è‚É£ Internet + Display
                setLoader("internet");
                setLoader("display");
                await sleep(600);

                const system = await ipcRenderer.invoke("perform-system-checks");

                if (!system.internet) {
                    setCross("internet");
                    throw ["internet"];
                }
                setTick("internet");

                if (!system.singleDisplay) {
                    setCross("display");
                    throw ["singleDisplay"];
                }
                setTick("display");

                // ‚úÖ ALL SYSTEM CHECKS PASSED
                document.getElementById("status-text").textContent = "System checks passed ‚úì";
                await sleep(800);

                // Step 2: Check maintenance mode
                document.getElementById("status-text").textContent = "Checking service status...";

                // Show service check
                const serviceElement = document.getElementById("service");
                serviceElement.classList.add('visible');
                setLoader("service");
                await sleep(800);

                // Check maintenance
                const isMaintenance = await ipcRenderer.invoke("check-maintenance");
                console.log("Maintenance check result:", isMaintenance);

                if (isMaintenance) {
                    // üî¥ MAINTENANCE MODE ACTIVE
                    setCross("service");
                    document.getElementById("status-text").textContent = "Service Under Maintenance";

                    // Show maintenance screen
                    await sleep(1500);
                    ipcRenderer.send("show-maintenance");
                } else {
                    // üü¢ ALL GOOD - PROCEED TO MAIN APP
                    setTick("service");
                    document.getElementById("status-text").textContent = "All checks passed ‚úì";
                    await sleep(1200);

                    // Send signal to show main window
                    ipcRenderer.send("system-checks-passed");
                }

            } catch (failedItems) {
                // ‚ùå SYSTEM CHECK FAILED
                console.error("System check failed:", failedItems);
                if (Array.isArray(failedItems)) {
                    ipcRenderer.send("system-check-failed", failedItems);
                } else {
                    console.error("Unexpected error:", failedItems);
                    // Fallback: try to show main window anyway
                    ipcRenderer.send("system-checks-passed");
                }
            }
        }

        // Start checks when page loads
        window.onload = runAllChecks;
    </script>
</body>

</html>